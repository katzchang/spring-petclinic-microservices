receivers:
  prometheus/internal:
    config:
      scrape_configs:
      - job_name: 'otel-collector'
        scrape_interval: 10s
        static_configs:
        - targets: ['0.0.0.0:8888']
        metric_relabel_configs:
          - source_labels: [ __name__ ]
            regex: '.*grpc_io.*'
            action: drop
  prometheus/services:
    config:
      scrape_configs:
      - job_name: api-gateway
        metrics_path: /actuator/prometheus
        static_configs:
        - targets: ['api-gateway:8080']
      - job_name: customers-service
        metrics_path: /actuator/prometheus
        static_configs:
        - targets: ['customers-service:8081']
      - job_name: visits-service
        metrics_path: /actuator/prometheus
        static_configs:
        - targets: ['visits-service:8082']
      - job_name: vets-service
        metrics_path: /actuator/prometheus
        static_configs:
        - targets: ['vets-service:8083']
  zipkin:
    endpoint: 0.0.0.0:9411

processors:
  batch:
  memory_limiter:
    check_interval: 2s
    limit_mib: 512
  resource/environment:
    attributes:
    - key: deployment.environment
      action: insert
      value: petclinic-microservice-lab

exporters:
  sapm:
    access_token: "${SPLUNK_ACCESS_TOKEN}"
    endpoint: "${SPLUNK_TRACE_URL}"
  signalfx:
    access_token: "${SPLUNK_ACCESS_TOKEN}"
    api_url: "${SPLUNK_API_URL}"
    ingest_url: "${SPLUNK_INGEST_URL}"

service:
  pipelines:
    traces:
      receivers: [zipkin]
      processors: [memory_limiter, batch, resource/environment]
      exporters: [sapm, signalfx]
    metrics/internal:
      receivers: [prometheus/services, prometheus/internal]
      processors: [memory_limiter, batch, resource/environment]
      exporters: [signalfx]
